<!DOCTYPE html>
{# Determine language direction based on current locale injected from context_processor #}
{% set lang_code = current_locale %}
{% set text_dir = 'rtl' if lang_code == 'fa' else 'ltr' %}
<html lang="{{ lang_code }}" dir="{{ text_dir }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} - {{ _('Meeting Minutes') }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="icon" href="{{ url_for('static', filename='images/main-logo.png') }}" type="image/png">
    {% if current_locale != 'fa' and en_font_css %}
    <link href="{{ en_font_css }}" rel="stylesheet">
    {% endif %}
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@200..700" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    {% if text_dir == 'rtl' %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css">
    {% endif %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/main.css') }}">

    {% if text_dir=='rtl' and fa_regular_url %}
    <style>
      @font-face { font-family: 'AppFa'; src: url('{{ fa_regular_url }}') format('{{ fa_regular_format or 'woff2' }}'); font-weight: 400; font-style: normal; font-display: swap; }
      {% if fa_bold_url %}
      @font-face { font-family: 'AppFa'; src: url('{{ fa_bold_url }}') format('{{ fa_bold_format or 'woff2' }}'); font-weight: 700; font-style: normal; font-display: swap; }
      {% endif %}
    </style>
    {% endif %}

    <style>
        :root { --header-h: 72px; }
        html[dir="rtl"] body, html[dir="rtl"] .btn, html[dir="rtl"] .form-control, html[dir="rtl"] .form-select, html[dir="rtl"] h1, html[dir="rtl"] h2, html[dir="rtl"] h3, html[dir="rtl"] h4, html[dir="rtl"] h5, html[dir="rtl"] h6 { font-family: '{{ 'AppFa' if text_dir=='rtl' and fa_regular_url else 'Vazirmatn' }}', sans-serif; }
        {% if text_dir == 'rtl' %}
            body { text-align: right; }
            .ms-auto { margin-right: auto !important; margin-left: 0 !important; }
            .me-auto { margin-left: auto !important; margin-right: 0 !important; }
            .text-end { text-align: left !important; }
            .text-start { text-align: right !important; }
            .navbar-nav { padding-right: 0; }
        {% endif %}
        /* Toasts bottom */
        .toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 1055; width: 350px; max-width: calc(100% - 2rem); }
        html[dir="rtl"] .toast-container { right: auto; left: 1rem; }
        .toast-alert { position: relative; overflow: hidden; opacity: 0; transform: translateY(20px); transition: opacity .5s, transform .5s; margin-bottom: .5rem; width: 100%; padding-right: 1rem; padding-left: 1rem; }
        .toast-alert.show { opacity: 1; transform: translateY(0); }
        .toast-alert.fade-out { opacity: 0; transform: translateY(20px); transition: opacity .3s, transform .3s; }
        .toast-progress { position: absolute; bottom: 0; left: 0; height: 4px; width: 100%; background-color: rgba(0, 0, 0, 0.15); animation: shrink 5s linear forwards; }
        html[dir="rtl"] .toast-progress { left: auto; right: 0; }
        @keyframes shrink { from { width: 100%; } to { width: 0%; } }
        /* Sidebar */
        .sidebar { background: var(--bs-body-bg); border-radius: .5rem; border: 1px solid rgba(0,0,0,.06); box-shadow: 0 6px 18px rgba(0,0,0,.06); }
        .sidebar .nav-link { padding: .5rem .75rem; border-radius: .5rem; display: flex; align-items: center; gap: .6rem; }
        .sidebar .nav-link i, .sidebar .nav-link .material-symbols-rounded { font-size: 1.05rem; opacity: .85; }
        .sidebar .nav-link.active, .sidebar .nav-link:hover { background: rgba(0,0,0,.05); }
        .sidebar-sticky { position: sticky; top: var(--header-h); height: calc(100dvh - var(--header-h) - .5rem); display: flex; flex-direction: column; }
        .sidebar-header { padding: .9rem; border-bottom: 1px solid rgba(0,0,0,.06); display: flex; align-items: center; justify-content: center; }
        .sidebar-header img { height: 28px; }
        .sidebar-content { flex: 1 1 auto; overflow: auto; padding: .25rem .5rem; }
        .sidebar-footer { margin-top: auto; border-top: 1px solid rgba(0,0,0,.06); padding: .5rem; display: flex; align-items: center; justify-content: space-between; }
        /* Offcanvas adjustments to keep footer at bottom */
        .offcanvas-body { display: flex; flex-direction: column; }
        .offcanvas-body .sidebar-sticky { position: static; height: 100%; }
        /* Header card */
        .header-card { background: var(--bs-body-bg); border: 1px solid rgba(0,0,0,.06); border-radius: .5rem; padding: .5rem .75rem; box-shadow: 0 6px 18px rgba(0,0,0,.05); }
        .search-input { max-width: 320px; background: #f1f3f5; border-radius: .35rem; border: 1px solid rgba(0,0,0,.06); }
        .theme-switch { position: relative; width: 52px; height: 28px; background: #e0e0e0; border-radius: 999px; border: 1px solid rgba(0,0,0,.1); cursor: pointer; display: inline-flex; align-items: center; padding: 2px; overflow: hidden; direction: ltr; }
        .theme-switch .knob { width: 22px; height: 22px; border-radius: 50%; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,.2); transition: transform .2s; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; }
        [data-theme="dark"] .theme-switch { background: #222; }
        [data-theme="dark"] .theme-switch .knob { transform: translateX(24px); background: #111; color: #ffd54f; }
        .flag-icon { width: 22px; height: 22px; border-radius: 4px; border: 1px solid rgba(0,0,0,.08); object-fit: cover; }
        /* Ensure Jalali datepicker overlays above sticky header/offcanvas */
        .jalali-datepicker { z-index: 20000 !important; }
    </style>
</head>
<body class="d-flex flex-column min-vh-100 bg-body-tertiary page-bg" data-locale="{{ current_locale }}">
    <div class="toast-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {% set alert_class = 'alert-' + category if category in ['success', 'danger', 'info', 'warning'] else 'alert-secondary' %}
                    <div class="alert {{ alert_class }} fade toast-alert" role="alert">{{ _(message) }}<div class="toast-progress"></div></div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="container-fluid px-2">
        <header class="sticky-top my-2" id="appHeader">
            <div class="header-card d-flex flex-wrap align-items-center justify-content-between gap-2">
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-outline-secondary d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas"><i class="bi bi-list"></i></button>
                    <span class="fw-bold">{{ _('MeetingMinutes') }}</span>
                </div>
                <div class="d-flex align-items-center gap-2 flex-grow-1 justify-content-center">
                    <div id="welcomeText" class="small text-muted">{{ 'خوش آمدید' if text_dir=='rtl' else _('Welcome') }}{% if current_user.is_authenticated %} {{ current_user.username }}{% endif %} | <span id="currentDateTime"></span></div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <form class="d-none d-md-flex" method="get" action="{{ url_for('meetings_list') }}">
                        <input name="q" class="form-control form-control-sm search-input" placeholder="{{ 'جستجو در کل سایت...' if text_dir=='rtl' else _('Search...') }}" />
                    </form>
                    <div class="theme-switch" id="themeToggle" role="button" aria-label="Theme toggle">
                        <div class="knob"><span class="material-symbols-rounded">light_mode</span></div>
                    </div>
                    <div class="d-flex align-items-center gap-2 ms-2">
                        <a class="btn btn-outline-secondary btn-sm p-1" href="{{ url_for('set_language', lang_code='fa') }}" title="فارسی"><img class="flag-icon" src="{{ url_for('static', filename='images/flag-for-iran-svgrepo-com.svg') }}" alt="fa"></a>
                        <a class="btn btn-outline-secondary btn-sm p-1" href="{{ url_for('set_language', lang_code='en') }}" title="English"><img class="flag-icon" src="{{ url_for('static', filename='images/england-svgrepo-com.svg') }}" alt="en"></a>
                        {% if current_user.is_authenticated %}
                        {% set avatar = current_user.avatar_path and url_for('static', filename='images/' + current_user.avatar_path) or url_for('static', filename='images/default_avatar.svg') %}
                        <a class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-1" href="{{ url_for('settings') }}?tab=account" title="{{ _('Account Settings') }}">
                          <img src="{{ avatar }}" alt="avatar" style="height:22px;width:22px;border-radius:50%;object-fit:cover;border:1px solid rgba(0,0,0,.1)">
                          <span class="d-none d-md-inline">{{ current_user.display_name or current_user.username }}</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </header>

        <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarOffcanvasLabel">
          <div class="offcanvas-header border-bottom">
            <h6 class="offcanvas-title" id="sidebarOffcanvasLabel">{{ _('Navigation') }}</h6>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body sidebar">
            <div class="sidebar-sticky">
                <div class="sidebar-header"><img src="{{ url_for('static', filename='images/main-logo.png') }}" alt="logo"></div>
                <div class="sidebar-content">
                    <ul class="nav flex-column gap-1">
                      <li class="nav-item"><a class="nav-link {{ 'active' if request.endpoint == 'index' else '' }}" href="{{ url_for('index') }}"><i class="bi bi-house"></i><span>{{ _('Home') }}</span></a></li>
                      {% if current_user.is_authenticated %}
                      <li class="nav-item"><a class="nav-link {{ 'active' if request.endpoint == 'new_meeting' else '' }}" href="{{ url_for('new_meeting') }}"><i class="bi bi-plus-lg"></i><span>{{ _('New Meeting') }}</span></a></li>
                      <li class="nav-item"><a class="nav-link {{ 'active' if request.endpoint == 'meetings_list' else '' }}" href="{{ url_for('meetings_list') }}"><i class="bi bi-journal-text"></i><span>{{ _('My Meetings') }}</span></a></li>
                      {% endif %}
                    </ul>
                </div>
                <div class="sidebar-footer">
                   <div class="d-flex align-items-center gap-2">
                       <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('settings') }}" title="{{ _('Settings') }}"><i class="bi bi-gear"></i></a>
                       <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('settings') }}?tab=account" title="{{ _('Profile') }}"><i class="bi bi-person"></i></a>
                   </div>
                   {% if current_user.is_authenticated %}
                   <a class="btn btn-outline-danger btn-sm" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i> {{ _('Logout') }}</a>
                   {% endif %}
                </div>
            </div>
          </div>
        </div>

        <div class="row gx-3 mt-2">
          <aside class="d-none d-lg-block col-lg-2">
            <div class="sidebar sidebar-sticky">
                <div class="sidebar-header"><img src="{{ url_for('static', filename='images/main-logo.png') }}" alt="logo"></div>
                <div class="sidebar-content">
                    <ul class="nav flex-column gap-1">
                      <li class="nav-item"><a class="nav-link {{ 'active' if request.endpoint == 'index' else '' }}" href="{{ url_for('index') }}"><i class="bi bi-house"></i><span>{{ _('Home') }}</span></a></li>
                      {% if current_user.is_authenticated %}
                      <li class="nav-item"><a class="nav-link {{ 'active' if request.endpoint == 'new_meeting' else '' }}" href="{{ url_for('new_meeting') }}"><i class="bi bi-plus-lg"></i><span>{{ _('New Meeting') }}</span></a></li>
                      <li class="nav-item"><a class="nav-link {{ 'active' if request.endpoint == 'meetings_list' else '' }}" href="{{ url_for('meetings_list') }}"><i class="bi bi-journal-text"></i><span>{{ _('My Meetings') }}</span></a></li>
                      {% endif %}
                    </ul>
                </div>
                <div class="sidebar-footer">
                   <div class="d-flex align-items-center gap-2">
                       <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('settings') }}" title="{{ _('Settings') }}"><i class="bi bi-gear"></i></a>
                       <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('settings') }}?tab=account" title="{{ _('Profile') }}"><i class="bi bi-person"></i></a>
                   </div>
                   {% if current_user.is_authenticated %}
                   <a class="btn btn-outline-danger btn-sm" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i> {{ _('Logout') }}</a>
                   {% endif %}
                </div>
            </div>
          </aside>
          <main role="main" class="col-12 col-lg-10">
            {% block content %}{% endblock %}
          </main>
        </div>

        <footer class="footer py-2 bg-light border-top mt-2">
          <div class="container-fluid text-center small text-muted">{{ _('Meeting Minutes App') }}</div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toastAlerts = document.querySelectorAll('.toast-container .toast-alert');
            const dismissDuration = 5000;
            toastAlerts.forEach(alert => {
                setTimeout(() => { alert.classList.add('show'); }, 100);
                const dismissToast = () => {
                    if (!alert.classList.contains('fade-out')) {
                        alert.classList.add('fade-out');
                        alert.classList.remove('show');
                        setTimeout(() => { alert.remove(); }, 300);
                    }
                };
                setTimeout(dismissToast, dismissDuration);
            });
            function updateDT(){
                const el = document.getElementById('currentDateTime');
                if (!el) return;
                const now = new Date();
                el.textContent = now.toLocaleString('{{ 'fa-IR' if text_dir=='rtl' else 'en-GB' }}', { dateStyle:'medium', timeStyle:'short' });
            }
            updateDT(); setInterval(updateDT, 60000);
            const toggle = document.getElementById('themeToggle');
            if (toggle){
                toggle.addEventListener('click', ()=>{
                    const current = document.documentElement.getAttribute('data-theme')==='dark'?'dark':'light';
                    const next = current==='dark'?'light':'dark';
                    document.documentElement.setAttribute('data-theme', next);
                    try{ localStorage.setItem('mm_theme', next); }catch(e){}
                });
            }
            // Set dynamic header height for sidebar sizing
            const headerEl = document.getElementById('appHeader');
            const setHeaderH = () => {
                if (!headerEl) return;
                const styles = getComputedStyle(headerEl);
                const mt = parseFloat(styles.marginTop) || 0;
                const mb = parseFloat(styles.marginBottom) || 0;
                const h = headerEl.offsetHeight + mt + mb;
                document.documentElement.style.setProperty('--header-h', h + 'px');
            };
            setHeaderH();
            window.addEventListener('resize', setHeaderH);
        });
    </script>
</body>
</html>
